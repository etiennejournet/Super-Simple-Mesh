apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-simple-mtls-connection
  labels:
    app: test-simple-mtls-connection
spec:
  replicas: 1
  selector:
    matchLabels:
      app: test-simple-mtls-connection
  template:
    metadata:
      labels:
        app: test-simple-mtls-connection
      annotations:
        cert-manager.ssm.io/service-name: "test-simple-mtls-connection.default.svc.cluster.local"
    spec:
      containers:
      - name: alpine
        image: alpine:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Test external connection";
          wget -qO- -T3 googler.fr > /dev/null 2>&1 || exit 1;
          echo -e  "\n"
          echo "Test connection to nginx service on http port";
          wget -qO- -T3 nginx.default.svc.cluster.local || exit 1;
          echo -e "\n";
          echo "Test connection to nginx service on 8000 port";
          wget -qO- -T3 nginx-different-port.default.svc.cluster.local:8000
          if [ $? == 0 ]
          then
            echo "Error, connection shouldn't have worked";
            exit 1
          fi
        ports:
        - containerPort: 80
